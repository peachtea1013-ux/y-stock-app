<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ãƒã‚¤åœ¨åº«ç®¡ç†ãƒ—ãƒ­</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #007bff; --danger: #dc3545; --success: #28a745; --warning: #ffc107; --dark: #343a40; }
        body { font-family: sans-serif; margin: 0; padding-bottom: 80px; background: #f4f7f6; color: #333; font-size: 14px; }
        
        /* èªè¨¼å‰ã®ç”»é¢ã‚’éš ã™ */
        #mainContent { display: none; }

        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; border-top: 1px solid #ddd; z-index: 100; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
        .nav-item { flex: 1; padding: 15px 5px; text-align: center; font-size: 0.8rem; color: #666; border-top: 3px solid transparent; }
        .nav-item.active { color: var(--primary); font-weight: bold; border-top-color: var(--primary); }

        .page { display: none; padding: 15px; animation: fadeIn 0.2s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .flex-row { display: flex; justify-content: space-between; align-items: center; }
        .input-std { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; margin-bottom: 10px; font-size: 16px; }
        
        .alert-box { background: #fff5f5; border: 1px solid #feb2b2; }
        button { border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.1s; }
        button:active { transform: scale(0.95); opacity: 0.8; }
        .btn-action { padding: 12px 5px; color: white; flex: 1; font-size: 0.9rem; }
        .btn-use { background: var(--danger); }
        .btn-in { background: var(--success); }
        .btn-req { background: var(--warning); color: #333; }
        .btn-main { background: var(--primary); color: white; width: 100%; padding: 15px; font-size: 1rem; }

        #inventoryOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 200; overflow-y: auto; display: none; }
        .category-badge { font-size: 0.75rem; background: #eef2f7; padding: 3px 10px; border-radius: 12px; color: #555; }
    </style>
</head>
<body>

    <div id="mainContent">
        <div id="page-stock" class="page active">
            <div style="background:var(--dark); color:white; padding:15px; border-radius:12px; text-align:center; margin-bottom:15px;">
                <small>åœ¨åº«ç·è³‡ç”£</small><br>
                <span style="font-size:1.6rem; font-weight:bold;">Â¥ <span id="totalMoneyDisplay">0</span></span>
            </div>
            <div style="display:flex; gap:8px; margin-bottom:15px;">
                <input type="text" id="searchInput" class="input-std" style="flex:2; margin-bottom:0;" placeholder="ğŸ” æ¤œç´¢..." oninput="render()">
                <select id="catFilter" class="input-std" style="flex:1; margin-bottom:0;" onchange="render()"></select>
            </div>
            <div id="shortageArea"></div>
            <div id="stockList"></div>
        </div>

        <div id="page-history" class="page">
            <h3>æ´»å‹•å±¥æ­´</h3>
            <div id="historyList"></div>
        </div>

        <div id="page-chart" class="page">
            <h3>æœˆé–“ä½¿ç”¨ãƒˆãƒ¬ãƒ³ãƒ‰</h3>
            <canvas id="usageChart" width="400" height="300"></canvas>
        </div>

        <div id="page-manage" class="page">
            <h3>ç®¡ç†ãƒ»ãƒ„ãƒ¼ãƒ«</h3>
            <button class="btn-main" style="background:#6f42c1; margin-bottom:20px;" onclick="openInventoryMode()">ğŸ“¦ æ£šå¸ã—ã‚’é–‹å§‹ã™ã‚‹</button>

            <div class="card">
                <h4 style="margin:0 0 12px 0;">æ–°è¦ã‚¢ã‚¤ãƒ†ãƒ ç™»éŒ²</h4>
                <input type="text" id="newName" class="input-std" placeholder="å•†å“å" list="list-names">
                <div style="display:flex; gap:8px;">
                    <input type="text" id="newMaker" class="input-std" placeholder="ãƒ¡ãƒ¼ã‚«ãƒ¼" list="list-makers">
                    <input type="text" id="newModel" class="input-std" placeholder="å‹å¼" list="list-models">
                </div>
                <div style="display:flex; gap:8px;">
                    <input type="text" id="newCat" class="input-std" placeholder="ã‚«ãƒ†ã‚´ãƒª" list="list-cats">
                    <input type="number" id="newPrice" class="input-std" placeholder="å˜ä¾¡(Â¥)" inputmode="numeric">
                </div>
                <input type="number" id="newMin" class="input-std" placeholder="æœ€ä½åœ¨åº«é€šçŸ¥ãƒ©ã‚¤ãƒ³" inputmode="numeric">
                <button class="btn-main" onclick="addItem()">ãƒã‚¹ã‚¿ãƒ¼ã«è¿½åŠ </button>
            </div>

            <div class="card" style="background:#f0fff4; border:1px solid #c6f6d5;">
                <h4 style="margin:0 0 10px 0;">ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</h4>
                <button onclick="copyAllToExcel()" style="background:#2f855a; color:white; width:100%; padding:12px;">Excelä¸€æ‹¬ã‚³ãƒ”ãƒ¼</button>
            </div>

            <h4>ç™»éŒ²æ¸ˆã¿ãƒã‚¹ã‚¿ãƒ¼</h4>
            <div id="editList"></div>
        </div>

        <div id="inventoryOverlay">
            <div style="padding:20px;">
                <div class="flex-row">
                    <h2>å®Ÿåœ¨åº«ã®ç¢ºèª</h2>
                    <button onclick="closeInventoryMode()" style="background:#eee; padding:8px 15px;">æˆ»ã‚‹</button>
                </div>
                <div id="inventoryList"></div>
                <button class="btn-main" style="background:var(--success); margin-top:20px;" onclick="finishInventory()">æ£šå¸ã—ã‚’ç¢ºå®š</button>
            </div>
        </div>

        <nav class="bottom-nav">
            <div class="nav-item active" onclick="showPage('stock')">åœ¨åº«</div>
            <div class="nav-item" onclick="showPage('history')">å±¥æ­´</div>
            <div class="nav-item" onclick="showPage('chart')">åˆ†æ</div>
            <div class="nav-item" onclick="showPage('manage')">ç®¡ç†</div>
        </nav>
    </div>

    <datalist id="list-names"></datalist>
    <datalist id="list-makers"></datalist>
    <datalist id="list-models"></datalist>
    <datalist id="list-cats"></datalist>

<script>
    // --- ğŸ”‘ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š ---
    const APP_PASS = "1234"; // â˜…ã“ã“ã‚’å¥½ããªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã«å¤‰æ›´ã—ã¦ãã ã•ã„

    function checkAuth() {
        const input = prompt("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        if (input === APP_PASS) {
            document.getElementById('mainContent').style.display = 'block';
            render();
        } else {
            alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚ã‚¢ã‚¯ã‚»ã‚¹ã‚’æ‹’å¦ã—ã¾ã—ãŸã€‚");
            document.body.innerHTML = "<h2 style='text-align:center;margin-top:50px;'>èªè¨¼ãŒå¿…è¦ã§ã™ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚</h2>";
        }
    }

    // èµ·å‹•æ™‚ã«èªè¨¼ã‚’å®Ÿè¡Œ
    window.onload = checkAuth;

    // --- ğŸ“¦ åœ¨åº«ç®¡ç†ãƒ­ã‚¸ãƒƒã‚¯ ---
    let items = JSON.parse(localStorage.getItem('myStockV3_items')) || [];
    let logs = JSON.parse(localStorage.getItem('myStockV3_logs')) || [];

    function showPage(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById('page-' + pageId).classList.add('active');
        event.currentTarget.classList.add('active');
        if(pageId === 'chart') updateChart();
        render();
    }

    function save() {
        localStorage.setItem('myStockV3_items', JSON.stringify(items));
        localStorage.setItem('myStockV3_logs', JSON.stringify(logs));
        render();
    }

    function addItem() {
        const ids = ['newName', 'newMaker', 'newModel', 'newCat', 'newPrice', 'newMin'];
        const [n, mk, md, c, p, mn] = ids.map(id => document.getElementById(id).value);
        if(!n) return alert("åå‰ã¯å¿…é ˆã§ã™");
        items.push({ id: Date.now(), name: n, maker: mk||'-', model: md||'-', category: c||'æœªåˆ†é¡', price: parseInt(p)||0, minStock: parseInt(mn)||0, count: 0 });
        ids.forEach(id => document.getElementById(id).value = '');
        save();
    }

    function doAction(id, type, multiplier) {
        const input = document.getElementById(`qty-${id}`);
        const val = parseInt(input.value) || 1;
        const item = items.find(i => i.id === id);
        if(type !== 'ä¾é ¼') item.count = Math.max(0, item.count + (val * multiplier));
        logs.unshift({ date: new Date().toLocaleString('ja-JP'), month: new Date().toISOString().slice(0,7), name: item.name, type: type, qty: val, price: item.price });
        if(logs.length > 200) logs.pop();
        input.value = '';
        save();
    }

    function render() {
        const search = document.getElementById('searchInput').value.toLowerCase();
        const filter = document.getElementById('catFilter').value || 'all';
        
        const updateDL = (id, key) => {
            const vals = [...new Set(items.map(i => i[key]))].filter(v => v && v !== '-');
            document.getElementById(id).innerHTML = vals.map(v => `<option value="${v}">`).join('');
        };
        ['list-names','list-makers','list-models','list-cats'].forEach((id,idx)=>updateDL(id,['name','maker','model','category'][idx]));

        const cats = [...new Set(items.map(i => i.category))];
        document.getElementById('catFilter').innerHTML = '<option value="all">å…¨ã‚«ãƒ†ã‚´ãƒª</option>' + cats.map(c => `<option value="${c}" ${filter===c?'selected':''}>${c}</option>`).join('');

        document.getElementById('totalMoneyDisplay').innerText = items.reduce((s, i) => s + (i.count * i.price), 0).toLocaleString();

        const shorts = items.filter(i => i.count <= i.minStock);
        document.getElementById('shortageArea').innerHTML = shorts.length ? `<div class="card alert-box"><div style="color:var(--danger);font-weight:bold;margin-bottom:5px;">âš ï¸ è¦è£œå……</div>${shorts.map(s => `<small>${s.name}</small>`).join(', ')}</div>` : '';

        const filtered = items.filter(i => {
            const mS = i.name.toLowerCase().includes(search) || i.maker.toLowerCase().includes(search) || i.model.toLowerCase().includes(search);
            const mC = filter === 'all' || i.category === filter;
            return mS && mC;
        });

        document.getElementById('stockList').innerHTML = filtered.map(i => `
            <div class="card ${i.count <= i.minStock ? 'alert-box' : ''}">
                <div class="flex-row">
                    <div style="flex:1;">
                        <span class="category-badge">${i.category}</span>
                        <div style="font-size:0.75rem; color:#888; margin:4px 0;">${i.maker} / ${i.model}</div>
                        <strong style="font-size:1.1rem;">${i.name}</strong>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-size:1.6rem; font-weight:bold;">${i.count}</div>
                        <div style="font-size:0.75rem; color:var(--primary);">Â¥${(i.count * i.price).toLocaleString()}</div>
                    </div>
                </div>
                <div style="display:flex; gap:8px; margin-top:12px;">
                    <input type="number" id="qty-${i.id}" class="input-std" style="flex:1; margin:0; text-align:center;" placeholder="1" inputmode="numeric">
                    <button class="btn-action btn-use" onclick="doAction(${i.id}, 'ä½¿ç”¨', -1)">ä½¿ç”¨</button>
                    <button class="btn-action btn-in" onclick="doAction(${i.id}, 'ç´å…¥', 1)">ç´å…¥</button>
                    <button class="btn-action btn-req" onclick="doAction(${i.id}, 'ä¾é ¼', 0)">ä¾é ¼</button>
                </div>
            </div>
        `).join('');

        document.getElementById('historyList').innerHTML = logs.map(l => `<div style="padding:10px; border-bottom:1px solid #eee; font-size:0.85rem;">${l.date.slice(5)} | <strong>${l.name}</strong> | ${l.type}(${l.qty})</div>`).join('');
        document.getElementById('editList').innerHTML = items.map(i => `<div class="card flex-row"><span>${i.name}</span><button onclick="if(confirm('å‰Šé™¤ï¼Ÿ')){items=items.filter(x=>x.id!=${i.id});save();}" style="color:red; background:none;">å‰Šé™¤</button></div>`).join('');
    }

    function openInventoryMode() {
        document.getElementById('inventoryOverlay').style.display = 'block';
        document.getElementById('inventoryList').innerHTML = items.map(i => `
            <div class="card flex-row">
                <span><strong>${i.name}</strong><br><small>${i.model}</small></span>
                <span>ç¾ç‰©: <input type="number" id="inv-${i.id}" value="${i.count}" style="width:70px; padding:10px;" inputmode="numeric"></span>
            </div>`).join('');
    }
    function closeInventoryMode() { document.getElementById('inventoryOverlay').style.display = 'none'; }
    function finishInventory() {
        items.forEach(i => {
            const nV = parseInt(document.getElementById(`inv-${i.id}`).value) || 0;
            if(i.count !== nV) {
                logs.unshift({ date: new Date().toLocaleString('ja-JP'), month: new Date().toISOString().slice(0,7), name: i.name, type: 'æ£šå¸èª¿æ•´', qty: nV - i.count, price: i.price });
                i.count = nV;
            }
        });
        save(); closeInventoryMode(); alert("æ£šå¸å®Œäº†");
    }

    let chartObj;
    function updateChart() {
        const ctx = document.getElementById('usageChart').getContext('2d');
        const mths = [...new Set(logs.map(l => l.month))].sort().slice(-6);
        const data = mths.map(m => logs.filter(l => l.month === m && l.type === 'ä½¿ç”¨').reduce((s, l) => s + l.qty, 0));
        if(chartObj) chartObj.destroy();
        chartObj = new Chart(ctx, { type: 'bar', data: { labels: mths, datasets: [{ label: 'æœˆé–“ä½¿ç”¨é‡', data: data, backgroundColor: '#007bff' }] } });
    }

    function copyAllToExcel() {
        let t = "ã€ç¾åœ¨åœ¨åº«ã€‘\nå•†å“å\tãƒ¡ãƒ¼ã‚«ãƒ¼\tå‹å¼\tã‚«ãƒ†ã‚´ãƒª\tåœ¨åº«æ•°\tå˜ä¾¡\tå°è¨ˆ\n";
        items.forEach(i => t += `${i.name}\t${i.maker}\t${i.model}\t${i.category}\t${i.count}\t${i.price}\t${i.count*i.price}\n`);
        t += "\nã€å±¥æ­´ã€‘\næ—¥æ™‚\tå•†å“å\tç¨®åˆ¥\tæ•°é‡\té‡‘é¡\n";
        logs.forEach(l => t += `${l.date}\t${l.name}\t${l.type}\t${l.qty}\t${l.qty*l.price}\n`);
        navigator.clipboard.writeText(t).then(() => alert("ä¸€æ‹¬ã‚³ãƒ”ãƒ¼æˆåŠŸï¼"));
    }
</script>
</body>
</html>
